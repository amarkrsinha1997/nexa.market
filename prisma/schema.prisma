// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String          @id @default(uuid())
  email                    String          @unique
  name                     String?
  username                 String?         @unique
  role                     String          @default("USER") // ADMIN, USER
  googleId                 String?         @unique
  picture                  String?
  refreshToken             String?
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt
  dateOfBirth              DateTime?
  phoneNumber              String?
  nexaWalletAddress        String?
  isOnboardingCompleted    Boolean         @default(false)
  referralCode             String?         @unique
  isEarlyUser              Boolean         @default(false)
  walletAddressChangeCount Int             @default(0)
  lastLoginAt              DateTime?
  orders                   Order[]
  walletHistory            WalletHistory[]
}

model WalletHistory {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  address   String
  createdAt DateTime @default(now())
}

model Order {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  amountINR  Float // Amount paid in INR
  nexaAmount Float // Calculated Nexa amount
  nexaPrice  Float // Price snapshot (INR per Nexa)

  status OrderStatus @default(ORDER_CREATED)

  paymentQrId         String // Which QR was shown
  nexaAddress         String? // Frozen Nexa wallet address for this order
  transactionId       String? // User provided Ref/UTR
  nexaTransactionHash String? // Blockchain transaction hash for released payment

  // Payment tracking for retry system
  paymentAttemptedAt      DateTime? // When payment was first attempted
  paymentRecipientAddress String? // Nexa address payment was sent to
  paymentFailureReason    String? // Reason if payment failed

  verifiedBy String? // Admin ID who verified
  checkedBy  String? // Admin ID who is checking/locking the order
  lifecycle  Json? // Audit log of status changes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum OrderStatus {
  ORDER_CREATED // Initial order creation
  VERIFICATION_PENDING // Payment submitted, awaiting admin verification
  VERIFYING // Admin is verifying the payment (Locked)
  ADMIN_APPROVED // Admin has approved - ready for payment release
  REJECTED // Admin rejected the payment
  RELEASE_PAYMENT // Payment release in progress
}

model AppConfig {
  key         String  @id @unique
  value       String
  description String?
}

model Upi {
  id           String  @id @default(uuid())
  vpa          String  @unique // Virtual Payment Address (e.g. merchant@upi)
  merchantName String?
  isActive     Boolean @default(true)
  isFallback   Boolean @default(false) // If true, this UPI is used when no scheduled UPI is available

  // Scheduling fields - time in HH:mm format (e.g., "09:00", "17:00")
  scheduleStart String? // Time when UPI becomes active each day
  scheduleEnd   String? // Time when UPI becomes inactive each day

  // Rotation & tracking
  priority   Int       @default(0) // Lower number = higher priority
  lastUsedAt DateTime? // Track when last selected
  usageCount Int       @default(0) // Total times used

  // Metadata
  notes         String?
  maxDailyLimit Float? // Optional daily transaction limit

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
